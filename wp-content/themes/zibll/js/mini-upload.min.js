var ToB64=function(a,i){if("undefined"==typeof FileReader)return notyf("当前浏览器不支持图片上传，请更换浏览器","danger");var t=new FileReader;t.readAsDataURL(a[0]),t.onload=function(a){i&&i(a.target.result)}},jqXhr=function(a){return jqXhr.onprogress=a,function(){var a=$.ajaxSettings.xhr();return"function"!=typeof jqXhr.onprogress?a:(jqXhr.onprogress&&a.upload&&(a.upload.onprogress=jqXhr.onprogress),a)}};_win.bd.on("change",'[zibupload="image_upload"]',function(a){var i=$(this),t=i.parents(".form-upload, .mini-upload")||i.parents("form"),n=t.find('[zibupload="select_but"]')||i.siblings(".but"),e=n.html(),r=this.files||a.dataTransfer.files,s=Number(_win.up_max_size)||2,o=i.attr("data-preview")||".preview";o=t.find(o);var d='<i class="loading mr6"></i>请稍候';return _win.preview=o.html(),-1==r[0].type.indexOf("image")?(notyf("选择的文件不是图像文件！","danger"),i.val("")):s&&r[0].size>1024e3*s?(notyf("所选图片大小不能超过"+s+"M，请重新选择","danger"),i.val("")):void(o.length&&(o.append('<div class="abs-center text-center fa-3x"><i class="loading"></i></div>'),n.html(d),ToB64(r,function(a){o.html('<img class="fit-cover" src="'+a+'">'),n.html(e),t.find("[auto-submit]").click()})))});var miniupload_ing=!1;_win.bd.on("click",'[zibupload="submit"]',function(e){if(miniupload_ing)return notyf("正在处理中，请勿重复提交","warning","2000");e.preventDefault?e.preventDefault():e.returnValue=!1;var _this=$(this),form=_this.parents(".form-upload, .mini-upload")||_this.parents("form"),_text=_this.html(),formData=new FormData,in_up=form.find('[zibupload="image_upload"]'),in_b=form.find('[zibupload="select_but"]')||in_up.siblings(".but"),is_files=!1;if(in_up.each(function(){tag=$(this).attr("data-tag")||"file",fileObject=this.files[0],fileObject&&(formData.append(tag,fileObject),is_files=!0)}),!is_files)return notyf("请先选择图片！","danger");form.find("input,[data-name]").each(function(){var a=$(this),i=a.attr("name")||a.attr("data-name"),t=a.val()||a.attr("data-value");void 0===t&&(t=""),i&&formData.append(i,t)});var miniuploaded=function(){_this.attr("disabled",!1).html(_text),in_b.attr("disabled",!1),in_up.attr("disabled",!1).val(""),miniupload_ing=!1,_win.preview&&form.find(".preview").html(_win.preview)};notyf("正在处理请稍等...","load","","miniupload_ajax"),_this.attr("disabled",!0).html('<i class="loading mr3 c-white"></i><span class="loading-text c-white">上传中<count class="px12 ml3"></count></span><div class="progress progress-striped active"><div class="progress-bar progress-bar-success" role="progressbar" style="width:0;"></div></div>'),in_up.attr("disabled",!0),in_b.attr("disabled",!0),miniupload_ing=!0,$.ajax({url:_win.ajax_url,type:"POST",data:formData,processData:!1,cache:!1,contentType:!1,dataType:"json",error:function(a){notyf("操作失败 "+a.status+" "+a.statusText+"，请刷新页面后重试","danger","","miniupload_ajax"),miniuploaded()},xhr:jqXhr(function(a){var i=Math.round(a.loaded/a.total*100);_this.find("count").html(i+"%"),i>=100&&_this.find(".loading-text").html("处理中 ..."),form.find(".progress .progress-bar").css("width",i+"%")}),success:function(n){ys=n.ys?n.ys:n.error?"danger":"",notyf(n.msg||"操作成功",ys,"","miniupload_ajax"),miniuploaded(),fun=_this.attr("zibupload-success"),fun&&n.img_url&&(eval(fun+"(n,_this,form)"),"function"==typeof fun&&fun(n,_this,form))}})});